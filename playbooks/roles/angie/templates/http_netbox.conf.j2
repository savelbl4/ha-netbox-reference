server {
    listen {{ vip_address_2 }}:443 ssl;
    listen 127.0.0.1:80;
{#    # CHANGE THIS TO YOUR SERVER'S NAME#}
    server_name {{ FQDN }} {{ vip_address_2 }};

    ssl_certificate {{ angie_cert_path }};
    ssl_certificate_key {{ angie_key_path }};

    client_max_body_size 25m;

{#    # HSTS (только если везде HTTPS)#}
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;


    location /static/ {
        alias /opt/netbox/netbox/static/;
    }

    location =/p8s {
        prometheus all;
    }

    location / {
        proxy_pass http://127.0.0.1:8001;

{#        # КЛЮЧЕВОЕ: TLS завершается здесь, значит фиксируем https/443#}
        proxy_set_header Host               $host;
        proxy_set_header X-Forwarded-Host   $host;
        proxy_set_header X-Forwarded-Proto  https;
        proxy_set_header X-Forwarded-Port   443;
{#        # реальный IP клиента#}
        proxy_set_header X-Real-IP          $remote_addr;
        proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
{##}
        proxy_http_version 1.1;
        proxy_set_header Connection         "";
        proxy_redirect off;
    }
}

server {
{#    # Redirect HTTP traffic to HTTPS#}
    listen {{ vip_address_2 }}:{{ angie_listen_port }};
    server_name _;
    return 301 https://$host$request_uri;
}
